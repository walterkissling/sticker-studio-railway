<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sticker Studio ‚ú® | Custom AI Stickers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    header p {
      opacity: 0.9;
      margin-top: 8px;
    }

    .trial-badge {
      display: inline-block;
      padding: 10px 24px;
      background: rgba(107, 203, 119, 0.95);
      border-radius: 50px;
      font-weight: 600;
      margin-top: 15px;
      font-size: 0.95rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .trial-badge.warning { background: rgba(255, 193, 7, 0.95); }
    .trial-badge.expired { background: rgba(255, 107, 107, 0.95); }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 800px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: white;
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    .card h2 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #333;
    }

    label {
      display: block;
      font-weight: 600;
      color: #444;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    textarea, input[type="text"] {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.2s;
    }

    textarea { min-height: 90px; }

    textarea:focus, input:focus {
      outline: none;
      border-color: #764ba2;
    }

    .hint {
      font-size: 0.85rem;
      color: #888;
      margin-top: 6px;
    }

    .style-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 8px;
    }

    .style-btn {
      padding: 12px 8px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      font-family: inherit;
    }

    .style-btn:hover { border-color: #764ba2; }

    .style-btn.active {
      border-color: #764ba2;
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
      font-weight: 600;
    }

    .size-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 8px;
    }

    .size-btn {
      padding: 14px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      text-align: center;
    }

    .size-btn:hover { border-color: #764ba2; }

    .size-btn.active {
      border-color: #764ba2;
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
    }

    .size-btn .name { font-weight: 600; color: #333; }
    .size-btn .dims { font-size: 0.8rem; color: #666; margin-top: 2px; }

    .quantity-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 8px;
    }

    .qty-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid #764ba2;
      background: white;
      color: #764ba2;
      font-size: 1.4rem;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .qty-btn:hover { background: #764ba2; color: white; }

    .qty-value {
      font-size: 1.6rem;
      font-weight: 700;
      min-width: 50px;
      text-align: center;
    }

    .btn-primary {
      width: 100%;
      padding: 18px;
      margin-top: 24px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-size: 1.15rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 4px 20px rgba(102,126,234,0.4);
      transition: all 0.2s;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(102,126,234,0.5);
    }

    .btn-primary:disabled { opacity: 0.7; cursor: wait; }

    .divider {
      text-align: center;
      margin: 20px 0;
      color: #999;
      font-size: 0.9rem;
    }

    .upload-area {
      padding: 16px;
      border: 2px dashed #ddd;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      color: #666;
      font-weight: 500;
      transition: all 0.2s;
    }

    .upload-area:hover { border-color: #764ba2; color: #764ba2; }
    .upload-area input { display: none; }

    .status {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      font-size: 0.95rem;
    }

    .status.success { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    .status.info { background: #e3f2fd; color: #1565c0; }

    .preview-area {
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f5f7fa, #e8eaed);
      border-radius: 16px;
      border: 2px dashed #ddd;
      overflow: hidden;
    }

    .preview-placeholder {
      text-align: center;
      color: #999;
      padding: 40px;
    }

    .preview-placeholder .icon {
      font-size: 4rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .preview-image {
      max-width: 100%;
      max-height: 320px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }

    .loading { text-align: center; padding: 40px; }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #e0e0e0;
      border-top-color: #764ba2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .action-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-outline {
      flex: 1;
      padding: 14px;
      border: 2px solid #764ba2;
      border-radius: 50px;
      background: white;
      color: #764ba2;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-outline:hover { background: #764ba2; color: white; }

    .btn-edit {
      flex: 1;
      padding: 14px;
      border: 2px solid #ff9800;
      border-radius: 50px;
      background: white;
      color: #ff9800;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-edit:hover { background: #ff9800; color: white; }

    .btn-success {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, #56ab2f, #a8e063);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 4px 15px rgba(86,171,47,0.3);
      transition: all 0.2s;
    }

    .btn-success:hover { transform: translateY(-2px); }

    .btn-download {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border: 2px solid #667eea;
      border-radius: 50px;
      background: white;
      color: #667eea;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .order-summary {
      margin-top: 20px;
      padding: 18px;
      background: linear-gradient(135deg, #f5f7fa, #e8eaed);
      border-radius: 14px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .summary-row:last-child {
      border-bottom: none;
      padding-top: 14px;
      margin-top: 6px;
    }

    .summary-row .label { color: #666; }
    .summary-row .value { font-weight: 500; }

    .summary-row.total .label,
    .summary-row.total .value {
      font-weight: 700;
      font-size: 1.2rem;
      color: #764ba2;
    }

    /* Edit Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.visible { opacity: 1; visibility: visible; }

    .modal {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      transform: scale(0.9);
      transition: all 0.3s;
    }

    .modal-overlay.visible .modal { transform: scale(1); }

    .modal h2 { margin-bottom: 20px; color: #333; }

    .modal-image {
      width: 140px;
      height: 140px;
      object-fit: cover;
      border-radius: 12px;
      margin: 0 auto 20px;
      display: block;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .form-group { margin-bottom: 20px; }

    .edit-preview-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .edit-hint {
      background: #fff3e0;
      border-radius: 10px;
      padding: 12px;
      font-size: 0.85rem;
      color: #e65100;
      margin-bottom: 16px;
    }

    .history-section {
      margin-top: 28px;
    }

    .history-section .card h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-clear {
      font-size: 0.8rem;
      padding: 6px 14px;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      background: white;
      color: #999;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s;
    }

    .history-clear:hover { border-color: #c62828; color: #c62828; }

    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .history-item {
      position: relative;
      cursor: pointer;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
      aspect-ratio: 1;
    }

    .history-item:hover { border-color: #764ba2; transform: translateY(-2px); }

    .history-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .history-item .history-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 4px 6px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 0.7rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-empty {
      text-align: center;
      color: #999;
      padding: 24px;
      font-size: 0.95rem;
    }

    /* Sheet Builder Modal */
    .sheet-modal {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 600px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: all 0.3s;
    }

    .modal-overlay.visible .sheet-modal { transform: scale(1); }

    .sheet-modal h2 { margin-bottom: 20px; color: #333; }

    .sheet-size-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .sheet-size-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      text-align: center;
      transition: all 0.2s;
    }

    .sheet-size-btn:hover { border-color: #764ba2; }

    .sheet-size-btn.active {
      border-color: #764ba2;
      background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1));
      font-weight: 600;
    }

    .sheet-size-btn .s-name { font-weight: 600; color: #333; }
    .sheet-size-btn .s-info { font-size: 0.8rem; color: #666; margin-top: 2px; }

    .slots-indicator {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      color: #764ba2;
      margin-bottom: 16px;
    }

    .sheet-preview-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
      min-height: 52px;
      padding: 10px;
      background: #f5f7fa;
      border-radius: 12px;
    }

    .sheet-slot {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      border: 2px dashed #ccc;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sheet-slot.filled {
      border: 2px solid #764ba2;
    }

    .sheet-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .sheet-designs-label {
      font-weight: 600;
      color: #444;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .sheet-thumb-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      max-height: 260px;
      overflow-y: auto;
    }

    .sheet-thumb {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e0e0e0;
      aspect-ratio: 1;
      transition: all 0.2s;
    }

    .sheet-thumb.in-use { border-color: #764ba2; }

    .sheet-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .sheet-thumb-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 4px;
      background: rgba(0,0,0,0.65);
    }

    .sheet-thumb-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: white;
      color: #764ba2;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .sheet-thumb-btn:hover { background: #764ba2; color: white; }
    .sheet-thumb-btn:disabled { opacity: 0.4; cursor: default; }

    .sheet-thumb-count {
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
      min-width: 18px;
      text-align: center;
    }

    .sheet-email-row { margin-bottom: 20px; }

    .sheet-email-row input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-family: inherit;
      font-size: 1rem;
      margin-top: 6px;
    }

    .sheet-email-row input:focus { outline: none; border-color: #764ba2; }

    .sheet-price {
      text-align: center;
      font-size: 1.3rem;
      font-weight: 700;
      color: #764ba2;
      margin-bottom: 16px;
    }

    .sheet-actions {
      display: flex;
      gap: 12px;
    }

    .sheet-submit:disabled { opacity: 0.5; cursor: not-allowed; }

    .sheet-empty-hint {
      text-align: center;
      color: #999;
      padding: 16px;
      font-size: 0.9rem;
    }

    .order-sheet-hint {
      text-align: center;
      color: #666;
      padding: 10px 0 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>‚ú® Sticker Studio ‚ú®</h1>
      <p>Create custom AI-powered stickers</p>
      <div class="trial-badge" id="trialBadge">
        üéÅ <span id="trialCount">5</span> designs remaining today
      </div>
    </header>

    <div class="main-grid">
      <div class="card">
        <h2>üé® Design Your Sticker</h2>

        <div class="form-group">
          <label>Describe your sticker:</label>
          <textarea id="prompt" placeholder="A golden retriever puppy wearing sunglasses on a beach..."></textarea>
          <p class="hint">üí° Be specific! Include colors, mood, and details you want.</p>
        </div>

        <div class="form-group">
          <label>Choose style:</label>
          <div class="style-grid" id="styleGrid">
            <button class="style-btn active" data-style="realistic">üì∑ Realistic</button>
            <button class="style-btn" data-style="cartoon">üé® Cartoon</button>
            <button class="style-btn" data-style="kawaii">üå∏ Kawaii</button>
            <button class="style-btn" data-style="watercolor">üñåÔ∏è Watercolor</button>
            <button class="style-btn" data-style="3d">üéÆ 3D Render</button>
            <button class="style-btn" data-style="minimalist">‚ú® Minimal</button>
            <button class="style-btn" data-style="vintage">üìú Vintage</button>
            <button class="style-btn" data-style="neon">üíú Neon</button>
          </div>
        </div>

        <div class="form-group">
          <label>Size:</label>
          <div class="size-grid" id="sizeGrid">
            <button class="size-btn active" data-size="medium">
              <div class="name">Medium</div>
              <div class="dims">7√ó7cm</div>
              <div class="dims">8 per sheet</div>
            </button>
            <button class="size-btn" data-size="large">
              <div class="name">Large</div>
              <div class="dims">10√ó10cm</div>
              <div class="dims">4 per sheet</div>
            </button>
          </div>
        </div>

        <button class="btn-primary" id="generateBtn">‚ú® Generate Sticker</button>

        <div class="divider">‚Äî or ‚Äî</div>

        <label class="upload-area" id="uploadArea">
          üìÅ Upload your own image
          <input type="file" accept="image/*" id="uploadInput">
        </label>

        <div class="status" id="status" style="display: none;"></div>
      </div>

      <div class="card">
        <h2>üëÄ Preview</h2>

        <div class="preview-area" id="previewArea">
          <div class="preview-placeholder">
            <div class="icon">üñºÔ∏è</div>
            <p>Your sticker will appear here</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">Enter a description and click Generate!</p>
          </div>
        </div>

        <div id="previewActions" style="display: none;">
          <div class="action-row">
            <button class="btn-outline" id="regenerateBtn">üîÑ New</button>
            <button class="btn-edit" id="editBtn">‚úèÔ∏è Edit</button>
            <button class="btn-success" id="orderBtn">‚úì Order</button>
          </div>
          <button class="btn-download" id="downloadBtn">‚¨áÔ∏è Download Image</button>

          <div class="order-summary">
            <div class="summary-row">
              <span class="label">Size:</span>
              <span class="value" id="summarySize">Medium (7√ó7cm)</span>
            </div>
            <p class="order-sheet-hint">Click <strong>Order</strong> to build your sheet with multiple designs</p>
          </div>
        </div>
      </div>
    </div>

    <div class="history-section" id="historySection" style="display: none;">
      <div class="card">
        <h2>
          üïí Previous Designs
          <button class="history-clear" id="clearHistory">Clear All</button>
        </h2>
        <div class="history-grid" id="historyGrid"></div>
      </div>
    </div>

  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2>‚úèÔ∏è Edit Your Sticker</h2>
      <div class="edit-preview-container">
        <img class="modal-image" id="editPreviewImage" src="" alt="Current sticker">
      </div>
      <div class="edit-hint">
        üí° Describe what you want to change: "make the background blue", "add sparkles", "remove the hat", etc.
      </div>
      <div class="form-group">
        <label>Edit instructions:</label>
        <input type="text" id="editPrompt" placeholder="Add a rainbow in the background...">
      </div>
      <div class="modal-actions">
        <button class="btn-outline" id="cancelEdit">Cancel</button>
        <button class="btn-edit" id="applyEdit" style="background: #ff9800; color: white;">‚úèÔ∏è Apply Edit</button>
      </div>
    </div>
  </div>

  <!-- Sheet Builder Modal -->
  <div class="modal-overlay" id="sheetModal">
    <div class="sheet-modal">
      <h2>üìã Build Your Sheet</h2>

      <div class="sheet-size-toggle" id="sheetSizeToggle">
        <button class="sheet-size-btn active" data-size="medium">
          <div class="s-name">Medium</div>
          <div class="s-info">7√ó7cm ‚Äî 8 per sheet</div>
        </button>
        <button class="sheet-size-btn" data-size="large">
          <div class="s-name">Large</div>
          <div class="s-info">10√ó10cm ‚Äî 4 per sheet</div>
        </button>
      </div>

      <div class="slots-indicator" id="slotsIndicator">0 / 8 filled</div>

      <div class="sheet-preview-row" id="sheetPreviewRow"></div>

      <div class="sheet-designs-label">Your designs:</div>
      <div class="sheet-thumb-grid" id="sheetThumbGrid"></div>

      <div class="sheet-email-row">
        <label>Your Email:</label>
        <input type="email" id="sheetEmail" placeholder="your@email.com">
      </div>

      <div class="sheet-price" id="sheetPrice">‚Ç°0</div>

      <div class="sheet-actions">
        <button class="btn-outline" id="cancelSheet">Cancel</button>
        <button class="btn-success sheet-submit" id="submitSheet" disabled>‚úì Submit Order</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      prompt: '',
      style: 'realistic',
      size: 'medium',
      image: null,
      trialsRemaining: 5,
      sessionId: localStorage.getItem('sessionId') || Math.random().toString(36).substr(2, 9),
      history: JSON.parse(localStorage.getItem('stickerHistory') || '[]'),
      // Sheet builder state
      sheet: {
        size: 'medium',
        // Map: history index -> count of slots used by that design
        counts: {}
      }
    };

    localStorage.setItem('sessionId', state.sessionId);

    const sizes = {
      medium: { name: 'Medium', dims: '7√ó7cm', perSheet: 8 },
      large: { name: 'Large', dims: '10√ó10cm', perSheet: 4 }
    };

    const styleNames = {
      realistic: 'üì∑ Realistic',
      cartoon: 'üé® Cartoon',
      kawaii: 'üå∏ Kawaii',
      watercolor: 'üñåÔ∏è Watercolor',
      '3d': 'üéÆ 3D Render',
      minimalist: '‚ú® Minimal',
      vintage: 'üìú Vintage',
      neon: 'üíú Neon'
    };

    const promptInput = document.getElementById('prompt');
    const generateBtn = document.getElementById('generateBtn');
    const previewArea = document.getElementById('previewArea');
    const previewActions = document.getElementById('previewActions');
    const statusEl = document.getElementById('status');
    const trialBadge = document.getElementById('trialBadge');
    const trialCount = document.getElementById('trialCount');

    // ----- Sheet helpers -----
    function getMaxSlots() {
      return sizes[state.sheet.size].perSheet;
    }

    function getTotalSlots() {
      return Object.values(state.sheet.counts).reduce((a, b) => a + b, 0);
    }

    function getSheetPrice() {
      return '5,000';
    }

    function formatPrice(val) {
      return `‚Ç°${val}`;
    }

    // ----- Init -----
    function init() {
      fetchTrials();
      setupEventListeners();
      renderHistory();
    }

    async function fetchTrials() {
      try {
        const res = await fetch(`/api/trials/${state.sessionId}`);
        const data = await res.json();
        state.trialsRemaining = data.trialsRemaining;
        updateTrialBadge();
      } catch (e) { console.log('Could not fetch trials'); }
    }

    function setupEventListeners() {
      promptInput.addEventListener('input', (e) => { state.prompt = e.target.value; });

      document.querySelectorAll('.style-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.style = btn.dataset.style;
          updateSummary();
        });
      });

      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.size = btn.dataset.size;
          updateSummary();
        });
      });

      generateBtn.addEventListener('click', generate);
      document.getElementById('regenerateBtn').addEventListener('click', generate);
      document.getElementById('uploadInput').addEventListener('change', handleUpload);
      document.getElementById('downloadBtn').addEventListener('click', downloadImage);
      document.getElementById('orderBtn').addEventListener('click', showSheetModal);

      // Edit functionality
      document.getElementById('editBtn').addEventListener('click', showEditModal);
      document.getElementById('cancelEdit').addEventListener('click', hideEditModal);
      document.getElementById('applyEdit').addEventListener('click', applyEdit);
      document.getElementById('editPrompt').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') applyEdit();
      });

      document.getElementById('editModal').addEventListener('click', (e) => {
        if (e.target.id === 'editModal') hideEditModal();
      });

      // Sheet modal
      document.getElementById('cancelSheet').addEventListener('click', hideSheetModal);
      document.getElementById('submitSheet').addEventListener('click', submitSheetOrder);
      document.getElementById('sheetModal').addEventListener('click', (e) => {
        if (e.target.id === 'sheetModal') hideSheetModal();
      });

      // Sheet size toggle
      document.querySelectorAll('.sheet-size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.sheet-size-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.sheet.size = btn.dataset.size;
          // Trim excess slots when switching to fewer
          trimSheetSlots();
          renderSheetModal();
        });
      });

      document.getElementById('clearHistory').addEventListener('click', clearHistory);
    }

    function updateSummary() {
      document.getElementById('summarySize').textContent = `${sizes[state.size].name} (${sizes[state.size].dims})`;
    }

    function updateTrialBadge() {
      trialCount.textContent = state.trialsRemaining;
      trialBadge.classList.remove('warning', 'expired');
      if (state.trialsRemaining === 1) {
        trialBadge.classList.add('warning');
      } else if (state.trialsRemaining <= 0) {
        trialBadge.classList.add('expired');
        trialBadge.innerHTML = 'üéÅ Daily limit reached - come back tomorrow!';
      }
    }

    function showStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
    }

    function hideStatus() { statusEl.style.display = 'none'; }

    function showLoading(message = 'Creating your sticker...') {
      previewArea.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p style="color: #666;">${message}</p>
          <p style="color: #999; font-size: 0.85rem; margin-top: 8px;">This may take 15-30 seconds</p>
        </div>
      `;
    }

    function showImage(src, skipHistory) {
      state.image = src;
      previewArea.innerHTML = `<img class="preview-image" src="${src}" alt="Generated sticker">`;
      previewActions.style.display = 'block';
      updateSummary();
      if (!skipHistory) {
        saveToHistory(src, state.prompt || 'Custom upload');
      }
    }

    function saveToHistory(image, prompt) {
      // Avoid duplicates of the exact same image
      state.history = state.history.filter(h => h.image !== image);
      state.history.unshift({ image, prompt, date: Date.now() });
      // Keep max 20 entries to avoid localStorage limits
      if (state.history.length > 20) state.history = state.history.slice(0, 20);
      localStorage.setItem('stickerHistory', JSON.stringify(state.history));
      renderHistory();
    }

    function renderHistory() {
      const section = document.getElementById('historySection');
      const grid = document.getElementById('historyGrid');
      if (state.history.length === 0) {
        section.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      grid.innerHTML = state.history.map((item, i) => `
        <div class="history-item" data-index="${i}" title="${item.prompt}">
          <img src="${item.image}" alt="${item.prompt}">
          <div class="history-label">${item.prompt}</div>
        </div>
      `).join('');
      grid.querySelectorAll('.history-item').forEach(el => {
        el.addEventListener('click', () => {
          const idx = parseInt(el.dataset.index);
          const item = state.history[idx];
          state.prompt = item.prompt;
          promptInput.value = item.prompt;
          showImage(item.image, true);
          showStatus('Loaded from history', 'info');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }

    function clearHistory() {
      state.history = [];
      localStorage.removeItem('stickerHistory');
      renderHistory();
    }

    async function generate() {
      if (!state.prompt.trim()) {
        showStatus('Please enter a description first', 'error');
        return;
      }

      generateBtn.disabled = true;
      generateBtn.textContent = '‚è≥ Generating...';
      showLoading();
      hideStatus();

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: state.prompt,
            style: state.style,
            sessionId: state.sessionId
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Generation failed');

        state.trialsRemaining = data.trialsRemaining;
        updateTrialBadge();
        showImage(data.image);
        showStatus('Sticker created! üéâ', 'success');
      } catch (err) {
        console.error(err);
        showStatus(err.message || 'Generation failed. Please try again.', 'error');
        previewArea.innerHTML = `
          <div class="preview-placeholder">
            <div class="icon">üòÖ</div>
            <p>Generation failed</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
          </div>
        `;
      }

      generateBtn.disabled = false;
      generateBtn.textContent = '‚ú® Generate Sticker';
    }

    // Edit functionality
    function showEditModal() {
      document.getElementById('editPreviewImage').src = state.image;
      document.getElementById('editPrompt').value = '';
      document.getElementById('editModal').classList.add('visible');
      document.getElementById('editPrompt').focus();
    }

    function hideEditModal() {
      document.getElementById('editModal').classList.remove('visible');
    }

    async function applyEdit() {
      const editPrompt = document.getElementById('editPrompt').value.trim();
      if (!editPrompt) {
        alert('Please enter edit instructions');
        return;
      }

      hideEditModal();
      showLoading('Applying your edits...');

      try {
        const res = await fetch('/api/edit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            editPrompt: editPrompt,
            currentImage: state.image,
            sessionId: state.sessionId
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Edit failed');

        state.trialsRemaining = data.trialsRemaining;
        updateTrialBadge();
        showImage(data.image);
        showStatus('Sticker edited! üéâ', 'success');
      } catch (err) {
        console.error(err);
        showStatus(err.message || 'Edit failed. Please try again.', 'error');
        showImage(state.image); // Restore previous image
      }
    }

    function handleUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        showImage(evt.target.result);
        showStatus('Image uploaded! üéâ', 'success');
      };
      reader.readAsDataURL(file);
    }

    function downloadImage() {
      if (!state.image) return;
      const link = document.createElement('a');
      link.href = state.image;
      link.download = `sticker-${Date.now()}.png`;
      link.click();
    }

    // =================== Sheet Builder ===================

    function showSheetModal() {
      // Reset sheet state
      state.sheet.size = state.size; // default to current size selection
      state.sheet.counts = {};

      // Auto-add current preview image as first slot
      if (state.image && state.history.length > 0) {
        const idx = state.history.findIndex(h => h.image === state.image);
        if (idx >= 0) {
          state.sheet.counts[idx] = 1;
        }
      }

      // Sync toggle buttons
      document.querySelectorAll('.sheet-size-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.size === state.sheet.size);
      });

      renderSheetModal();
      document.getElementById('sheetModal').classList.add('visible');
    }

    function hideSheetModal() {
      document.getElementById('sheetModal').classList.remove('visible');
    }

    function trimSheetSlots() {
      const max = getMaxSlots();
      let total = getTotalSlots();
      if (total <= max) return;

      // Trim from the last-added designs (highest index keys added last)
      const keys = Object.keys(state.sheet.counts).map(Number).reverse();
      for (const k of keys) {
        if (total <= max) break;
        const remove = Math.min(state.sheet.counts[k], total - max);
        state.sheet.counts[k] -= remove;
        total -= remove;
        if (state.sheet.counts[k] <= 0) delete state.sheet.counts[k];
      }
    }

    function renderSheetModal() {
      const max = getMaxSlots();
      const filled = getTotalSlots();

      // Slots indicator
      document.getElementById('slotsIndicator').textContent = `${filled} / ${max} filled`;

      // Preview row ‚Äî small squares
      const previewRow = document.getElementById('sheetPreviewRow');
      let previewHTML = '';
      // Build ordered list of slot images
      const slotImages = [];
      const sortedKeys = Object.keys(state.sheet.counts).map(Number).sort((a, b) => a - b);
      for (const k of sortedKeys) {
        const count = state.sheet.counts[k];
        for (let i = 0; i < count; i++) {
          slotImages.push(state.history[k]?.image || '');
        }
      }
      for (let i = 0; i < max; i++) {
        if (i < slotImages.length && slotImages[i]) {
          previewHTML += `<div class="sheet-slot filled"><img src="${slotImages[i]}" alt="slot"></div>`;
        } else {
          previewHTML += `<div class="sheet-slot"></div>`;
        }
      }
      previewRow.innerHTML = previewHTML;

      // Thumbnail grid
      const grid = document.getElementById('sheetThumbGrid');
      if (state.history.length === 0) {
        grid.innerHTML = '<div class="sheet-empty-hint">No designs yet. Generate some stickers first!</div>';
      } else {
        grid.innerHTML = state.history.map((item, i) => {
          const count = state.sheet.counts[i] || 0;
          const canAdd = filled < max;
          const inUse = count > 0;
          return `
            <div class="sheet-thumb ${inUse ? 'in-use' : ''}" data-idx="${i}">
              <img src="${item.image}" alt="${item.prompt}" title="${item.prompt}">
              <div class="sheet-thumb-controls">
                <button class="sheet-thumb-btn sheet-minus" data-idx="${i}" ${count === 0 ? 'disabled' : ''}>‚àí</button>
                <span class="sheet-thumb-count">${count}</span>
                <button class="sheet-thumb-btn sheet-plus" data-idx="${i}" ${!canAdd ? 'disabled' : ''}>+</button>
              </div>
            </div>
          `;
        }).join('');

        // Bind +/- buttons
        grid.querySelectorAll('.sheet-plus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const idx = parseInt(btn.dataset.idx);
            if (getTotalSlots() < getMaxSlots()) {
              state.sheet.counts[idx] = (state.sheet.counts[idx] || 0) + 1;
              renderSheetModal();
            }
          });
        });
        grid.querySelectorAll('.sheet-minus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const idx = parseInt(btn.dataset.idx);
            if (state.sheet.counts[idx] > 0) {
              state.sheet.counts[idx]--;
              if (state.sheet.counts[idx] <= 0) delete state.sheet.counts[idx];
              renderSheetModal();
            }
          });
        });
      }

      // Price
      document.getElementById('sheetPrice').textContent = filled > 0 ? formatPrice(getSheetPrice()) : '‚Ç°0';

      // Submit button
      document.getElementById('submitSheet').disabled = filled === 0;
    }

    async function submitSheetOrder() {
      const email = document.getElementById('sheetEmail').value.trim();
      if (!email) {
        alert('Please enter your email address.');
        return;
      }

      const filled = getTotalSlots();
      if (filled === 0) {
        alert('Please add at least one design to the sheet.');
        return;
      }

      // Build unique images array and slots index array
      const uniqueImages = [];
      const imageIndexMap = {};   // history index -> position in uniqueImages
      const slots = [];
      const descParts = [];

      const sortedKeys = Object.keys(state.sheet.counts).map(Number).sort((a, b) => a - b);
      for (const hIdx of sortedKeys) {
        const count = state.sheet.counts[hIdx];
        if (count <= 0) continue;
        const item = state.history[hIdx];
        if (!item) continue;

        if (!(hIdx in imageIndexMap)) {
          imageIndexMap[hIdx] = uniqueImages.length;
          uniqueImages.push(item.image);
        }
        const uIdx = imageIndexMap[hIdx];
        for (let i = 0; i < count; i++) slots.push(uIdx);
        descParts.push(`${item.prompt} x${count}`);
      }

      const sizeLabel = `${sizes[state.sheet.size].name} (${sizes[state.sheet.size].dims})`;
      const totalSlots = slots.length;

      // Client-side payload size check
      const payloadStr = JSON.stringify({ images: uniqueImages });
      const payloadMB = new Blob([payloadStr]).size / (1024 * 1024);
      if (payloadMB > 9) {
        alert(`Payload is ~${payloadMB.toFixed(1)} MB which may be too large. Try using fewer unique designs.`);
        return;
      }

      const submitBtn = document.getElementById('submitSheet');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Submitting...';

      try {
        await fetch('/api/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'sheet',
            images: uniqueImages,
            slots: slots,
            size: sizeLabel,
            totalSlots: totalSlots,
            total: getSheetPrice(),
            descriptions: descParts,
            customerEmail: email
          })
        });

        hideSheetModal();
        alert(`Order submitted! üéâ\n\n${sizeLabel} ‚Äî ${totalSlots} stickers\nTotal: ${formatPrice(getSheetPrice())}\n\nWe'll be in touch soon!`);
      } catch (err) {
        alert('Order failed. Please try again.');
      }

      submitBtn.disabled = false;
      submitBtn.textContent = '‚úì Submit Order';
    }

    init();
  </script>
</body>
</html>
